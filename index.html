<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>CakePHP Fixture Factories</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/blood.css" id="theme">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css" id="highlight-theme">
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<h3>CakePHP Fixture Factories</h3>
					<p>
						<small>Created by <a href="http://hakim.se">Nicolas Masson</a> and <a href="https://github.com/hakimel/reveal.js/graphs/contributors">Juan Pablo Ramirez</a></small>
					</p>
					<aside class="notes">
						Welcome to our presentation on the Cakephp Fixture Factories <br>
						This work is presented to you by Nicolas Masson and myself, Juan-Pablo Ramirez <br>
					</aside>
				</section>
				<section>
					<section>
						<h3>Static vs. Dynamic Test Fixtures</h3>
						<aside class="notes">
							The presentation proposes a package to create test fixtures dynamically with the help of factories,
							which presents several advantages over the static CakePHP legacy approach.
						</aside>
					</section>
					<section>
						<h4>
							Static
						</h4>
						<p>
							Load many fixtures for each test
						</p>
						<p><pre data-id="code-animation"><code class="hljs" data-trim data-line-numbers="|3-5">
							public function testUserPermission()
							{
							   $user = $this->Users->get(45, [
						         'contain' => ['Groups.Permissions']
						   ])

							   $act = $this->Users->hasPermission($user, 'Foo');

							   $this->assertTrue($act);
							}
						</code></pre></p>
					</section>
					<section>
						<h4>
							Dynamic
						</h4>
						<p>
							Create fixtures on the fly
						</p>
						<p><pre data-id="code-animation"><code class="hljs" data-trim data-line-numbers="|3-5">
							public function testUserPermission()
							{
							   $user = UserFactory::make()
								->withPermission('Foo')
								->getEntity();

							   $act = $this->Users->hasPermission($user, 'Foo');

							   $this->assertTrue($act);
							}
						</code></pre></p>
					</section>
				</section>
				<section>
					<h3>Test should be</h3>

					<h4 class="fragment">Intelligible</h4>
					<h4 class="fragment">Usable</h4>
					<h4 class="fragment">Performant</h4>
					<aside class="notes">
						Tests should meet the following criteria: they should be intelligible.
						Ideally you should be able to read them like prose. <br>
						They should be easy to write and to maintain. The excuse:
						no time for writing tests should not be legitimate.
						Autocompletion should assist you.<br>
						They should run fast. To that aim, avoid
						interaction with the DB and do not load unnecessary fixtures.
					</aside>
				</section>
				<section>
					<h3>
						Why test?
					</h3>
					<ul>
						<li class="fragment">
							<h4>Clean code</h4>
						</li>
						<li class="fragment">
							<h4>Documentation</h4>
						</li>
						<li class="fragment">
							<h4>Code integrity</h4>
						</li>
						<li class="fragment">
							<h4>Saves time</h4>
						</li>
						<li class="fragment">
							<h4>Saves money</h4>
						</li>
					</ul>
					<aside class="notes">
						But why do we write tests? Tests force you to write clean code. If you struggle
						writing your test, it could be due to the complexity of the code your are testing <br>
						If you tests can easily be read and understood, they document your source code.<br>
						Whenever your code is refactored, or features are added, or external packages get updated,
						tests ensure that your code retains it's integrity. <br>
						Tests significantly reduce the amount of time spent on code maintenance.
					</aside>
				</section>
				<section
						data-background-image="assets/tree.jpg"
						data-background-size="contain"
				>
					<div style="background-color: rgba(0, 0, 0, 0); color: #fff; padding: 20px; margin: auto;">
						<h4>
							<small class="fragment fade-right">Tests are the roots of your code</small>
						</h4>
					</div>
					<aside class="notes">
						If your code is a tree, consider tests as its roots. It is its invisible part, the insures
						that your code grows stable, and does not get wiped out by the first storm.
					</aside>
				</section>
				<section>
					<h3>
						How to test?
					</h3>
					<div class="fragment">
						<p style="color: red">Arrange</p>
					</div>
					<div class="fragment">
						<p>Act</p>
					</div>
					<div class="fragment">
						<p style="color: darkgreen">
							Assert
						</p>
					</div>
					<aside class="notes">
						How do tests look like? Most of them will follow the famous AAA pattern.<br>
						Arrange will prepare the scenario of your test<br>
						Act will call the method under test<br>
						Assert will ensure that the result of the method meets expectations.
					</aside>
				</section>
				<section>
					<h3>
						Test user permissions
					</h3>
					<div class="fragment">
						<p style="color: red">
							Arrange <br>
							Create user, user group, permission, joining tables</p>
					</div>
					<div class="fragment">
						<p>
							Act <br>
							Check permission A for user
						</p>
					</div>
					<div class="fragment">
						<p style="color: green">
							Assert <br>
							Expect true
						</p>
					</div>
				</section>
				<section>
					<h4>Fixtures factories</h4>
					<section>
						<p><pre data-id="code-animation"><code class="hljs" data-trim data-line-numbers="|3-6|8-9|11-12|1-12">
							public function testUserPermission()
							{
							  // Arrange
							   $user = UserFactory::make()
								->withPermission('Foo')
								->getEntity();

							   // Act
							   $act = $this->Users->hasPermission($user, 'Foo');

							   // Assert
							   $this->assertTrue($act);
							}
						</code></pre></p>
					</section>
					<section>
						<p><pre data-id="code-animation"><code class="hljs" data-trim data-line-numbers="|4-7|11,13-14|17-19|17-25">
						public function dataProviderForUserWithPermissionFoo()
						{
						   return [
						      ['Admin', true],
						      ['Guru',  true],
						      ['Foo',   true],
						      ['Bar',   false],
						   ];
						}

						/** @dataProvider dataProviderForUserWithPermissionFoo */
						public function testUserHasPermissionFoo(
						   string $permission,
						   bool $expected
						)
						{
						   $user = UserFactory::make()
							->withPermission($permission)
							->getEntity();

						   $act = $this->Users->hasPermission($user, 'Foo');

						   $this->assertSame($expected, $act);
						}
						</code></pre></p>
					</section>
				</section>
				<section>
					<h3>Setup</h3>
					<section>
						<h4>Load the plugin</h4>
						<p><pre data-id="code-animation"><code class="hljs" data-trim>
						   // In Application.php
						   ...
						   protected function bootstrapCli(): void
						   {
						      // Load more plugins here
						      $this->addPlugin('CakephpFixtureFactories');
						   }
						</code></pre></p>
					</section>
					<section>
						<h4>
							Update the listeners in <i>phpunit.xml</i>
						</h4>
						<p><pre data-id="code-animation"><code class="hljs" data-trim>
							bin/cake fixture_factories_setup
						</code></pre></p>
					</section>
					<section>
						<h4>
							Bake your factories
						</h4>
						<p><pre data-id="code-animation"><code class="hljs" data-trim>
							bin/cake bake fixture_factory -h
						</code></pre></p>
					</section>
					<section>
						<h4>
							Migrations (optional)
						</h4>
						<p>
							<pre>In tests/bootstrap.php</pre>
						</p>
						<p><pre data-id="code-animation"><code class="hljs" data-trim>
						\CakephpFixtureFactories\TestSuite\Migrator::migrate();
						</code></pre></p>
						<p>
							<pre>Or with multiple locations:</pre>
						</p>

						<p><pre data-id="code-animation"><code class="hljs" data-trim>
						Migrator::migrate([
							['plugin' => 'FooPlugin'],
							['source' => 'BarFolder'],
							...
						 ]);
						</code></pre></p>
					</section>
				</section>
				<section>
					<h4>User Factory</h4>
					<p><pre data-id="code-animation"><code class="hljs" data-trim data-line-numbers="|8-11|13-22|24-28">
					namespace App\Test\Factory;

					use CakephpFixtureFactories\Factory\BaseFactory;
					use Faker\Generator;

					class UserFactory extends BaseFactory
					{
					   protected function getRootTableRegistryName(): string
					   {
					   	return "Users";
					   }

					   protected function setDefaultTemplate(): void
					   {
					   	$this->setDefaultData(function (Generator $faker) {
						   return [
						      'username' => $faker->userName
						      'password' => $faker->password,
						      'email'    => $faker->email,
						   ];
					   	});
					   }

					   public function withPermission(string $permission): self
					   {
					   	return $this->with('Groups.Permissions', [
						  'name' => $permission
						]);
					   }
					}


					</code></pre></p>
				</section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
		</script>
	</body>
</html>
